# @mchen-lab/app-kit

A standardized Node-centric application shell for the workspace fleet.

## Purpose
Provides a consistent foundation for web services, ensuring standardization across the fleet. It handles:
- **Scaffolding**: Rapidly creating new services with a standard directory structure.
- **Lifecycle Management**: Updating existing services to the latest standards via `app-kit update`.
- **Runtime**: Unified Express server setup with safe defaults (CORS, JSON, Logging).
- **Frontend Integration**: Seamless single-port development with Vite HMR.

## CLI Usage

### Creating a New Project
To create a new application, use `npx` to run the latest version of `app-kit`:

```bash
npx @mchen-lab/app-kit create <project-name> --port <port-number> [--with-frontend]
```

**Example:**
```bash
npx @mchen-lab/app-kit create my-service --port 3000 --with-frontend
```

### Updating an Existing Project
`app-kit` is designed to be updated. As the platform evolves, you can pull in the latest build scripts, Dockerfiles, and CI configs by running:

```bash
# Run inside your project root
npx @mchen-lab/app-kit update
```

## Configuration

### `devops.config.json`
This file is the source of truth for your project's infrastructure configuration. App-Kit uses it to generate `Dockerfile`, CI workflows, and release scripts.

**Example:**
```json
{
  "projectName": "My Service",
  "imageName": "my-service",
  "ghcrOrg": "mchen-lab",
  "ports": [3000]
}
```

### Managed Files (⚠️ CAUTION)
App-Kit enforces consistency by "managing" specific files. **Do not edit these files manually**, as they will be overwritten the next time you run `app-kit update`.

Managed files are marked with a header:
```typescript
// ===== AUTO-GENERATED BY APP-KIT - DO NOT EDIT =====
```

**Common Managed Files:**
- `Dockerfile`
- `vite.config.ts`
- `tsconfig.server.json`
- `.github/workflows/ci.yml`
- `restart.sh`
- Valid scripts in `devops/`
- `Dockerfile`
- `vite.config.ts`

## Versioning & Commit Tracking

App-Kit identifies your application's state using three key pieces of information:

1.  **Version**: Read from `package.json`. In production, this is prefixed with `v` and appended with `BUILD_METADATA` (e.g., `v0.1.0-dev-20260128`).
2.  **Commit Hash**: Captured from the host environment during build. 
    - **Development**: Vite attempts to run `git rev-parse --short HEAD`.
    - **Production**: Injected as an `ARG` during Docker build (`GIT_COMMIT`).
3.  **Port**: Dynamically reported by the backend API at runtime.

### ⚠️ Git Requirement
For the **Commit Hash** to be correctly captured, your project **must be a Git repository** with at least one commit. If it is not a git repo, the hash will display as `unknown`.

```bash
# Initialize git if you haven't already
git init
git add .
git commit -m "initial commit"
```

## Local Development

### `restart.sh`
Every App-Kit project comes with a robust `restart.sh` script. Use this for your daily development instead of `npm run dev` directly.

```bash
./restart.sh
```

**What it does:**
1.  **Ensures Clean Port**: Kills any zombies or orphan processes on your configured port.
2.  **Log Management**: Backs up old logs to `*.bak` so you don't lose history.
3.  **Starts Server**: Launches the backend in watch mode (which proxies to Vite for frontend HMR).
4.  **Tails Logs**: Streams the server output to your terminal.

## Runtime Library

For the backend code you write, `app-kit` provides a helper to set up Express with best practices.

```typescript
import { createApp } from "@mchen-lab/app-kit/backend";

const appKit = createApp({
  appName: "My Service",
  // app-kit automatically loads config from 'data/settings.json'
  defaultConfig: { 
    myFeatureEnabled: true 
  }
});

const app = appKit.app; // Configured Express instance

app.get("/api/hello", (req, res) => {
  res.json({ message: "Hello World" });
});

app.listen(3000);
```

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
